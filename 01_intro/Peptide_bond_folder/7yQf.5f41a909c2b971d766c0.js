(window.webpackJsonp=window.webpackJsonp||[]).push([["7yQf"],{aLUo:function(e,t,s){"use strict";var i=s("TqRt");Object.defineProperty(t,"__esModule",{value:!0}),t.default=t.UPDATE_USER_VIDEO_PROGRESS_MUTATION=void 0;var a=i(s("8OQS")),o=i(s("pVnL")),n=i(s("RPZL")),r=i(s("lTCR")),d=i(s("+a4J")),l=i(s("nSHN")),c=s("z39W"),u=s("8r+/"),h=i(s("x+rD")),g=i(s("12ks")),S=s("LrfN"),p=V(s("t1sY")),P=s("O6wL"),y=V(s("4PhQ")),f=i(s("mXPZ")),_=i(s("Jayu")),v=i(s("Q8Wn")),E=s("Vad+");const I=["points"];let T;function N(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,s=new WeakMap;return(N=function(e){return e?s:t})(e)}function V(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var s=N(t);if(s&&s.has(e))return s.get(e);var i={},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var n=a?Object.getOwnPropertyDescriptor(e,o):null;n&&(n.get||n.set)?Object.defineProperty(i,o,n):i[o]=e[o]}return i.default=e,s&&s.set(e,i),i}const L=(0,u.gqlOp)((0,r.default)(T||(T=(e=>e)`
    mutation updateUserVideoProgress($input: UserVideoProgressInput!) {
        updateUserVideoProgress(videoProgressUpdate: $input) {
            videoItemProgress {
                content {
                    id
                    progressKey
                    ... on Video {
                        downloadUrls
                    }
                }
                lastSecondWatched
                secondsWatched
                lastWatched
                points
                started
                completed
            }
            actionResults {
                pointsEarned {
                    points
                }
                tutorialNodeProgress {
                    contentId
                    progress
                }
                userProfile {
                    countVideosCompleted
                    points
                    countBrandNewNotifications
                }
                notificationsAdded {
                    badges
                    avatarParts
                    readable
                    urgent
                    toast
                    continueUrl
                }
                ... on VideoActionResults {
                    currentTask {
                        id
                        content {
                            id
                        }
                        pointBounty
                    }
                }
            }
            error {
                code
                debugMessage
            }
        }
    }
`)));t.UPDATE_USER_VIDEO_PROGRESS_MUTATION=L;var m=d.default.Model.extend({MIN_SECONDS_BETWEEN_SAVES:30,MIN_PERCENT_BETWEEN_SAVES:.1,MIN_SECONDS_BETWEEN_SAVES_PHANTOM:60,MIN_PERCENT_BETWEEN_SAVES_PHANTOM:.25,SANITY_CHECK_POLL_INTERVAL:1e4,REQUIRED_PERCENT_FOR_FULL_POINTS:.9,defaults:{points:0,pointsSaved:0,possiblePoints:750,videoKey:"",contentId:"",youtubeId:"0",playbackSpeedAvailable:!1,playbackRate:1,playerState:S.VideoPlayerState.UNSTARTED,numPolls:0,playerStateHistory:"",showOptions:!0,showPoints:!0,showInfo:!0,showShare:!0,showEditCaptions:!1,transcriptAvailable:!1,topicID:void 0,lessonID:void 0,useCaptionsDetectionFallback:!0,captionsLocale:"",hasPlayed:!1,getCurrentTimeIsDefinitelyWorking:!1,userHasHitPauseOnThisVideo:!1,_videoLogState:{secondsWatchedSinceSave:0,percentLastSaved:0,lastPollTime:new Date}},player:null,initialize:function(e){const t=[];for(const e in this)"function"==typeof this[e]&&t.push(e);t.forEach((e=>this[e]=this[e].bind(this))),f.default.isLoggedIn?this.set({secondsBetweenSaves:this.MIN_SECONDS_BETWEEN_SAVES,percentBetweenSaves:this.MIN_PERCENT_BETWEEN_SAVES,maxConsecutiveFailures:100}):this.set({secondsBetweenSaves:this.MIN_SECONDS_BETWEEN_SAVES_PHANTOM,percentBetweenSaves:this.MIN_PERCENT_BETWEEN_SAVES_PHANTOM,maxConsecutiveFailures:3}),this.maybeShowEditCaptionsButton(e.slug,e.translatedYoutubeLang),this.consecutiveFailures=0,this.listenToVideoStart();const s=(this.get("thumbnailUrls")||{}).filtered||"";this.set("thumbnailUrl",s)},listenToVideoStart:function(){const e=(t,s)=>{s===S.VideoPlayerState.PLAYING&&(h.default.sendEventToGA("videoStart",{videoSlug:this.get("nodeSlug")}),this.off("change:playerState",e))};this.on("change:playerState",e)},maybeShowEditCaptionsButton:function(e,t){const s=v.default.kaLocale;if(!s.startsWith("en")&&e){const i=s===t?1:0;this.set({showEditCaptions:!0,fanCaptionLink:`/translate/videos/${e}/subtitle?lang=${t}&dub=${i}`})}else this.set("showEditCaptions",!1)},markConversion:function(e){const t=this.get("markConversion");t?t(e):g.default.markConversion(e.id,e.extra,{activity:P.enums.Activity.WATCHING})},_getUpdatedSecondsWatched:function(e,t,s,i){let{secondsWatchedSinceSave:a,lastSecondWatched:o}=s;if(t===S.VideoPlayerState.PLAYING&&void 0===o)o=this.getVideoPosition(0);else if(e===S.VideoPlayerState.PLAYING){var n;const e=(i-s.lastPollTime)/1e3*this.get("playbackRate");a?a+=e:a=e,o=null!=(n=o)?n:0,o+=e}return{secondsWatchedSinceSave:a,lastSecondWatched:o}},_updatePlayerStateHistory:function(e,t,s,i,a){let o=this.get("playerStateHistory");return o+=this.get("numPolls")+e,o+=void 0!==s?`_${t}-${s}`:`_${t}`,o+=`_${this.get("playbackRate")}`,this.player&&this.player.getPlayerState&&(o+=`_${this.player.getPlayerState()}`),void 0===i&&void 0===a||(o+=`_${i||"0"}`,o+=`_${a||"0"}`),o+=";",this.set("playerStateHistory",o),o},_handleVideoLogPoll:function(e,t,s){const i=new Date,a=this.get("_videoLogState"),{lastSecondWatched:o}=this._getUpdatedSecondsWatched(e,t,a,i),r=this.getDuration();if(!0===s&&e===S.VideoPlayerState.PLAYING&&0!==r&&o>r+1)return this.setPlayerState(S.VideoPlayerState.ENDED),void h.default.sendNonInteractionEventToGA("event","Diagnostics","video-player-state-reset");if(e===S.VideoPlayerState.PLAYING){const e={type:"UPDATE_LAST_SECOND_WATCHED",readableId:this.get("readableId")||this.get("slug"),lastSecondWatched:o};_.default.dispatch(e)}this.set("numPolls",this.get("numPolls")+1);const d=t===S.VideoPlayerState.PLAYING,l=void 0!==t&&t!==S.VideoPlayerState.PLAYING;if(d?this.set("autoSaveTimer",setInterval((()=>this._handleVideoLogPoll(this.get("playerState"),void 0,!0)),this.SANITY_CHECK_POLL_INTERVAL)):l&&this.set("autoSaveTimer",clearInterval(this.get("autoSaveTimer"))),!d&&i-a.lastPollTime>2.5*this.SANITY_CHECK_POLL_INTERVAL)return this.set("_videoLogState",n.default.assoc(a,"lastPollTime",i)),void this._updatePlayerStateHistory("a",e,t);let c=n.default.assign(a,this._getUpdatedSecondsWatched(e,t,a,i),this._flushVideoLogStateAsNecessary(e,t,a,i),{lastPollTime:i});const u=Math.max(this.getVideoPosition(c.lastSecondWatched),c.secondsWatchedSinceSave);c=n.default.assign(c,{lastSecondWatched:u}),this.set("_videoLogState",c),this._updatePointsEstimate(c.secondsWatchedSinceSave)},_flushVideoLogStateAsNecessary:function(e,t,s,i){const a=t===S.VideoPlayerState.PLAYING,o=void 0!==t&&t!==S.VideoPlayerState.PLAYING,{secondsWatchedSinceSave:n,lastSecondWatched:r}=this._getUpdatedSecondsWatched(e,t,s,i),d=a&&this.getVideoPosition(s.lastSecondWatched)<1,l=e===S.VideoPlayerState.PLAYING&&!0===o&&n>1,c=t===S.VideoPlayerState.ENDED&&n>=1,u=this._isAutoSaveIntervalExceeded(n),g=e===S.VideoPlayerState.PLAYING&&s.percentLastSaved<this.REQUIRED_PERCENT_FOR_FULL_POINTS&&this.getCurrentPositionAsPercent(r)>=this.REQUIRED_PERCENT_FOR_FULL_POINTS;return d||l||c||u||g?(h.default.getGAReferrer().then((s=>{this._flushVideoLogState(n,r,e,t,s)})),{secondsWatchedSinceSave:0,percentLastSaved:this.getCurrentPositionAsPercent(r)}):(this._updatePlayerStateHistory("b",e,t,n,r),{})},_flushVideoLogState:function(e,t,s,i,a){const n=this;if(this.get("savingVideoLogState"))return void this._updatePlayerStateHistory("c",s,i,e,t);if(this.set("savingVideoLogState",!0),!p.areCookiesEnabled())return y.default.log("Cookies seem to be disabled. Not logging progress."),void this._updatePlayerStateHistory("d",s,i,e,t);if(this.consecutiveFailures>=this.get("maxConsecutiveFailures"))return y.default.error("Not sending video log due to too many failures",y.Errors.Internal),void this._updatePlayerStateHistory("e",s,i,e,t);this._updatePlayerStateHistory("",s,i,e,t),this.set("playerStateHistory","");const r=(d={contentId:this.get("contentId"),secondsWatched:e||0,lastSecondWatched:t||0,durationSeconds:this.getDuration(),lessonId:this.get("lessonID"),captionsLocale:this.captionsCurrentLanguage(),fallbackPlayer:"html"===this.get("playerType"),localTimezoneOffsetSeconds:-1*(new Date).getTimezoneOffset()*60,gaReferrer:a},Object.entries(d).filter((([e,t])=>void 0!==t)).reduce(((e,[t,s])=>(0,o.default)({},e,{[t]:s})),{}));var d;if(!r.contentId){const e={sentry:{extras:{youtubeId:this.get("youtubeId")}}};y.default.error("ContentId not set in call to updateUserVideoProgress",y.Errors.Internal,{metadata:e})}this.videoTaskView&&this.videoTaskView.model.recordWatch(t,e),i!==S.VideoPlayerState.PAUSED&&this.markConversion({id:"video_log_client",extra:(0,o.default)({},r,{youtubeId:this.get("youtubeId")})});(0,c.getUnsafeGqlClient)().mutate(L,{variables:{input:r},module:"multithreaded",refetchQueries:e=>{var t;const s=null==(t=e.data)?void 0:t.updateUserVideoProgress,i=this.get("completed");if(s&&!s.error&&s.videoItemProgress){const e=s.videoItemProgress.completed;if(!i&&e)return["UserAssignments"]}return[]}}).then((e=>{var s;const i=null==(s=e.data)?void 0:s.updateUserVideoProgress;if(null!=i&&i.error){const e=i.error.code;"CHEATING"!==e&&n._logFailedProgressUpdate(e,n.get("youtubeId"),t),n.consecutiveFailures+=1}else if(null!=i&&i.videoItemProgress)try{n.consecutiveFailures=0,l.default.respondToGraphQLAction(i.actionResults),n._finishSave(i.videoItemProgress)}catch(e){const s=e.code||500;n._logFailedProgressUpdate(s,n.get("youtubeId"),t,e)}else y.default.error("updateUserVideoProgress came back with both a null error and null videoItemProgress.",y.Errors.Internal)})).catch((e=>{y.default.error("Failed to update user video progress",y.Errors.Internal,e),n.consecutiveFailures+=1})).then((()=>{n.set("savingVideoLogState",!1)}))},_logFailedProgressUpdate:function(e,t,s,i=null){y.default.error("Failed to update user video progress. Error returned from GraphQL mutation",y.Errors.Internal,{cause:i,sentryData:{fingerprint:["updateUserVideoProgress",e],contexts:{extras:{errorCode:e,youtubeId:t,lastSecondWatched:s,youtubeLanguage:(0,E.getYoutubeLanguage)()}}}})},captionsCurrentLanguage:function(){let e=!1,t="",s={};if(!this.get("useCaptionsDetectionFallback"))return this.get("captionsLocale");if(null==this.player)return y.default.log("No player, no captions"),t;try{e=e||this.player.getOptions("cc").length>0,s=this.player.getOption("cc","track")}catch(e){}if(!e)try{e=this.player.getOptions("captions").length>0,s=this.player.getOption("captions","track")}catch(e){}return e&&"languageCode"in s&&(t=s.languageCode),t},_finishSave:function(e){this.set("pointsSaved",e.points);const{points:t}=e,s=(0,a.default)(e,I);t<this.get("points")?this.set(s):this.set(e);try{this.set("downloadUrls",JSON.parse(e.content.downloadUrls))}catch(e){y.default.error("Failed to parse downloadUrls",y.Errors.Internal,{cause:e})}const i={type:"UPDATE_STATUS",status:e.completed?"complete":"started",progressKey:e.content.progressKey};_.default.dispatch(i)},getVideoPosition:function(e,t){return this.player&&this.player.getCurrentTime?(this.player.getCurrentTime()>0&&!t&&this.set("getCurrentTimeIsDefinitelyWorking",!0),this.get("getCurrentTimeIsDefinitelyWorking")?this.player.getCurrentTime()||0:this.get("userHasHitPauseOnThisVideo")?0:e||0):0},_updatePointsEstimate:function(e){const t=this.getDuration();if(0===t)return;let s=Math.min(1,e/t)+this.get("pointsSaved")/this.get("possiblePoints");s>this.REQUIRED_PERCENT_FOR_FULL_POINTS&&(s=1);const i=Math.floor(this.get("possiblePoints")*s);i<this.get("points")||this.set({points:i})},_isAutoSaveIntervalExceeded:function(e){const t=this.getDuration()*this.get("percentBetweenSaves");return e>=Math.min(t,this.get("secondsBetweenSaves"))},setPlaybackRate:function(e){this._handleVideoLogPoll(this.get("playerState")),this.set("playbackRate",e)},getCurrentPositionAsPercent:function(e){const t=this.getDuration();return 0===t?0:Math.min(1,this.getVideoPosition(e)/t)},getDuration:function(){const e=this.player&&this.player.getDuration&&this.player.getDuration()||this.get("duration")||0;return Math.max(0,Math.floor(e))},setInitialPlayerState:function(e,t){if(null!=t&&this.setPlaybackRate(t),e===S.VideoPlayerState.PLAYING){const e=this.getVideoPosition(0);this.set("_videoLogState",n.default.assign(this.get("_videoLogState"),{secondsWatchedSinceSave:e,lastSecondWatched:e}))}this.setPlayerState(e)},setPlayerState:function(e){this._handleVideoLogPoll(this.get("playerState"),e);const t=this.get("playerState");this.set({playerState:e}),e===S.VideoPlayerState.UNSTARTED?this.set({userHasHitPauseOnThisVideo:!1}):e===S.VideoPlayerState.PAUSED&&this.set({userHasHitPauseOnThisVideo:!0}),t!==S.VideoPlayerState.PLAYING&&e===S.VideoPlayerState.PLAYING&&(this.get("hasPlayed")||(this.markConversion({id:"video_started_in_pageview",extra:{content_id:this.attributes.id,slug:this.attributes.nodeSlug,fallbackPlayer:"html"===this.get("playerType")}}),this.set("hasPlayed",!0)))}});t.default=m}}]);
//# sourceMappingURL=../../sourcemaps/en/7yQf.5f41a909c2b971d766c0.js.map